name: Build and deploy to gh-pages branch

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js (if needed)
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies (Node)
        if: exists('package.json')
        run: |
          if [ -f package-lock.json ]; then
            npm ci
          else
            npm install
          fi

      - name: Build (Node)
        if: exists('package.json') && contains(join(fromJson(format('[%s]', join(github.event.head_commit.message, ''))), ''), '') || always()
        run: |
          if npm run | grep -q " build"; then
            npm run build
          else
            echo "No npm build script found; skipping npm build"
          fi

      - name: Determine publish directory
        id: detect
        run: |
          set -euo pipefail
          PUBLISH_DIR=""
          for d in build dist public docs _site; do
            if [ -d "$d" ]; then PUBLISH_DIR="$d"; break; fi
          done
          if [ -z "$PUBLISH_DIR" ] && [ -f index.html ]; then
            PUBLISH_DIR="."
          fi
          if [ -z "$PUBLISH_DIR" ]; then
            echo "No publish dir detected; creating empty public/"
            mkdir -p public
            PUBLISH_DIR="public"
          fi
          echo "publish_dir=$PUBLISH_DIR" >> $GITHUB_OUTPUT

      - name: Deploy to gh-pages branch
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: ${{ steps.detect.outputs.publish_dir }}
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
